name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: win
          - os: macos-latest
            platform: mac
          - os: ubuntu-latest
            platform: linux

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Create .env file
        run: cp .env.example .env

      # For public repos: Use GITHUB_TOKEN (workflow token)
      - name: Create update-config.json
        run: |
          echo '{"token":"${{ secrets.GITHUB_TOKEN }}"}' > update-config.json
        shell: bash

      # For private repos: Uncomment below and comment out the step above
      # You'll need to create a GitHub Personal Access Token (PAT) with:
      # - Permissions: Contents (Read), Metadata (Read)
      # - Add it as a repository secret named GH_RELEASE_TOKEN
      # - The PAT must not expire (or have a long expiration)
      # - This is required because secrets.GITHUB_TOKEN expires after the workflow
      # - name: Create update-config.json (Private Repo)
      #   run: |
      #     echo '{"token":"${{ secrets.GH_RELEASE_TOKEN }}"}' > update-config.json
      #   shell: bash

      - name: Build and Make
        run: pnpm run make
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.platform }}
          path: |
            out/make/**/*
            out/*.exe
            out/*.zip
            out/*.dmg
            out/*.deb
            out/*.rpm
          retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-win
          path: artifacts/win

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-mac
          path: artifacts/mac

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-linux
          path: artifacts/linux

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            NOTES=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          else
            NOTES=$(git log --pretty=format:"- %s" --no-merges -20)
          fi
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ steps.version.outputs.version }}
          body: |
            ## What's Changed

            ${{ steps.changelog.outputs.notes }}

            ---

            ## Downloads

            **Windows:** Download `Electron-Starter-*-Windows-Setup.exe`
            **macOS (Intel):** Download `Electron-Starter-*-macOS-x64.zip`
            **macOS (Apple Silicon):** Download `Electron-Starter-*-macOS-arm64.zip`
            **Linux (Debian/Ubuntu):** Download `Electron-Starter-*-Linux-*.deb`
            **Linux (Fedora/RHEL):** Download `Electron-Starter-*-Linux-*.rpm`

            *Full changelog: CHANGELOG.md*
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          files: |
            artifacts/**/*Windows-Setup.exe
            artifacts/**/*macOS*.zip
            artifacts/**/*Linux*.deb
            artifacts/**/*Linux*.rpm
            artifacts/**/*.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
